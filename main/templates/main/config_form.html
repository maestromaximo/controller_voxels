{% extends 'main/base.html' %}

{% block content %}
<h2>Configure Simulation</h2>

<form method="post" id="simForm">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-4">
            <h4>General & Dimensions</h4>
            <div class="mb-3">
                {{ form.name.label_tag }} {{ form.name }}
            </div>
            <div class="row">
                <div class="col-6">{{ form.nx.label_tag }} {{ form.nx }}</div>
                <div class="col-6">{{ form.ny.label_tag }} {{ form.ny }}</div>
            </div>
            <div class="mb-3">{{ form.voxel_size.label_tag }} {{ form.voxel_size }}</div>
            <div class="mb-3">{{ form.duration.label_tag }} {{ form.duration }}</div>
            <div class="mb-3">{{ form.dt.label_tag }} {{ form.dt }}</div>
        </div>
        
        <div class="col-md-4">
            <h4>Physical Parameters</h4>
            <div class="mb-3">{{ form.density.label_tag }} {{ form.density }}</div>
            <div class="mb-3">{{ form.specific_heat.label_tag }} {{ form.specific_heat }}</div>
            <div class="mb-3">{{ form.thermal_conductivity.label_tag }} {{ form.thermal_conductivity }}</div>
            <div class="mb-3">{{ form.heater_heat_capacity.label_tag }} {{ form.heater_heat_capacity }}</div>
            <div class="mb-3">{{ form.coupling_mode.label_tag }} {{ form.coupling_mode }}</div>
            <div class="mb-3">{{ form.temp_ambient.label_tag }} {{ form.temp_ambient }}</div>
        </div>
        
        <div class="col-md-4">
            <h4>Control Parameters</h4>
            <div class="mb-3">{{ form.q_temp_weight.label_tag }} {{ form.q_temp_weight }}</div>
            <div class="mb-3">{{ form.q_energy_weight.label_tag }} {{ form.q_energy_weight }}</div>
            <div class="mb-3">{{ form.r_weight.label_tag }} {{ form.r_weight }}</div>
            <div class="mb-3">{{ form.p_max.label_tag }} {{ form.p_max }}</div>
            <div class="mb-3">{{ form.bryson_temp_max.label_tag }} {{ form.bryson_temp_max }}</div>
            <button type="submit" name="apply_bryson" value="1" class="btn btn-outline-secondary btn-sm">
                Apply Bryson's Rule
            </button>
        </div>
    </div>

    <hr>

    <div class="row mt-4">
        <div class="col-md-12">
            <h4>Target Temperature Grid</h4>
            <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyPreset('uniform')">Uniform (Ambient)</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyPreset('center')">Center Step (100°C)</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyPreset('gradient')">Gradient (Left 100, Right 20)</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyPreset('checker')">Checkerboard</button>
            </div>
            
            <div id="grid-container" class="voxel-grid"></div>
            
            <!-- Hidden field to store the matrix -->
            {{ form.target_temp_matrix }}
        </div>
    </div>

    <div class="card mt-4" id="optuna-section">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Tree-structured Parzen Estimator (Optuna)</span>
            <small class="text-muted">Searches for Q/R weights in ≤3 minutes</small>
        </div>
        <div class="card-body">
            <p class="mb-3">
                Launch Optuna's TPE sampler to automatically tune the LQR weights. This run is asynchronous,
                capped at 3 minutes, and reports live progress below.
            </p>
            <button type="button" class="btn btn-warning" id="optuna-start-btn">
                Start TPE Optimization
            </button>
            <div id="optuna-status" class="mt-3 d-none">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="optuna-progress-bar" role="progressbar" style="width: 0%">0%</div>
                </div>
                <pre id="optuna-log" class="bg-dark text-light p-2 mt-3" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem;"></pre>
                <div id="optuna-best" class="mt-3 d-none">
                    <p class="mb-2">Best score: <span id="optuna-best-score">--</span></p>
                    <button type="button" class="btn btn-success" id="optuna-apply-btn" disabled>Apply Best Weights</button>
                </div>
            </div>
            <div id="optuna-error" class="text-danger mt-2 d-none"></div>
        </div>
    </div>

    <div class="mt-4 mb-5">
        <button type="submit" class="btn btn-primary btn-lg">Save & Run Simulation</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    const nxInput = document.getElementById('id_nx');
    const nyInput = document.getElementById('id_ny');
    const ambientInput = document.getElementById('id_temp_ambient');
    const matrixInput = document.getElementById('id_target_temp_matrix');
    const gridContainer = document.getElementById('grid-container');

    function updateGrid() {
        const nx = parseInt(nxInput.value) || 5;
        const ny = parseInt(nyInput.value) || 5;
        
        gridContainer.style.gridTemplateColumns = `repeat(${nx}, 50px)`;
        
        // Save current values if possible
        const currentValues = [];
        document.querySelectorAll('.voxel-cell input').forEach(input => {
            currentValues.push(input.value);
        });

        gridContainer.innerHTML = '';
        
        let currentMatrix = [];
        try {
            currentMatrix = JSON.parse(matrixInput.value);
        } catch(e) {}

        for (let y = 0; y < ny; y++) {
            for (let x = 0; x < nx; x++) {
                const cell = document.createElement('div');
                cell.className = 'voxel-cell';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.1';
                input.dataset.x = x;
                input.dataset.y = y;
                
                // Try to preserve value or use ambient
                let val = ambientInput.value;
                if (currentMatrix[y] && currentMatrix[y][x] !== undefined) {
                    val = currentMatrix[y][x];
                }
                input.value = val;
                
                input.addEventListener('change', updateMatrixJson);
                
                cell.appendChild(input);
                gridContainer.appendChild(cell);
            }
        }
        updateMatrixJson();
    }

    function updateMatrixJson() {
        const nx = parseInt(nxInput.value) || 5;
        const ny = parseInt(nyInput.value) || 5;
        const matrix = [];
        
        const inputs = document.querySelectorAll('.voxel-cell input');
        
        for (let y = 0; y < ny; y++) {
            const row = [];
            for (let x = 0; x < nx; x++) {
                const index = y * nx + x;
                if (inputs[index]) {
                    row.push(parseFloat(inputs[index].value) || 0);
                } else {
                    row.push(parseFloat(ambientInput.value) || 0);
                }
            }
            matrix.push(row);
        }
        
        matrixInput.value = JSON.stringify(matrix);
    }

    function applyPreset(type) {
        const nx = parseInt(nxInput.value) || 5;
        const ny = parseInt(nyInput.value) || 5;
        const ambient = parseFloat(ambientInput.value) || 20.0;
        const inputs = document.querySelectorAll('.voxel-cell input');
        
        inputs.forEach(input => {
            const x = parseInt(input.dataset.x);
            const y = parseInt(input.dataset.y);
            
            if (type === 'uniform') {
                input.value = ambient;
            } else if (type === 'center') {
                if (x === Math.floor(nx/2) && y === Math.floor(ny/2)) {
                    input.value = 100.0;
                } else {
                    input.value = ambient;
                }
            } else if (type === 'gradient') {
                if (x < nx/2) {
                    input.value = 100.0;
                } else {
                    input.value = 20.0;
                }
            } else if (type === 'checker') {
                if ((x + y) % 2 === 0) {
                    input.value = 80.0;
                } else {
                    input.value = 40.0;
                }
            }
        });
        updateMatrixJson();
    }

    nxInput.addEventListener('change', updateGrid);
    nyInput.addEventListener('change', updateGrid);
    
    // Initialize
    updateGrid();

    // Optuna Optimization UI
    const optunaStartBtn = document.getElementById('optuna-start-btn');
    const optunaStatusBox = document.getElementById('optuna-status');
    const optunaProgressBar = document.getElementById('optuna-progress-bar');
    const optunaLog = document.getElementById('optuna-log');
    const optunaBestBox = document.getElementById('optuna-best');
    const optunaBestScore = document.getElementById('optuna-best-score');
    const optunaApplyBtn = document.getElementById('optuna-apply-btn');
    const optunaError = document.getElementById('optuna-error');
    const OPTUNA_START_URL = "{% url 'optimize_start' %}";
    const OPTUNA_STATUS_URL = "{% url 'optimize_status' %}";
    let optunaJobId = null;
    let optunaPollHandle = null;
    let optunaBestParams = null;

    function setOptunaProgress(percent) {
        const pct = Math.max(0, Math.min(100, percent || 0));
        optunaProgressBar.style.width = pct + '%';
        optunaProgressBar.textContent = pct + '%';
    }

    function resetOptunaUI() {
        optunaError.classList.add('d-none');
        optunaBestBox.classList.add('d-none');
        optunaApplyBtn.disabled = true;
        optunaBestParams = null;
        optunaLog.textContent = '';
        setOptunaProgress(0);
        optunaProgressBar.classList.remove('bg-success');
        optunaProgressBar.classList.add('progress-bar-animated');
    }

    function stopOptunaPolling() {
        if (optunaPollHandle) {
            clearInterval(optunaPollHandle);
            optunaPollHandle = null;
        }
        optunaJobId = null;
        optunaStartBtn.disabled = false;
        optunaProgressBar.classList.remove('progress-bar-animated');
    }

    function handleOptunaError(message) {
        stopOptunaPolling();
        optunaError.textContent = typeof message === 'string' ? message : JSON.stringify(message);
        optunaError.classList.remove('d-none');
    }

    function pollOptunaStatus() {
        if (!optunaJobId) {
            return;
        }
        fetch(`${OPTUNA_STATUS_URL}?job_id=${optunaJobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    handleOptunaError(data.error);
                    return;
                }
                optunaStatusBox.classList.remove('d-none');
                setOptunaProgress(data.percent || 0);
                if (data.progress_log !== undefined) {
                    optunaLog.textContent = data.progress_log;
                    optunaLog.scrollTop = optunaLog.scrollHeight;
                }
                if (data.best_params) {
                    optunaBestParams = data.best_params;
                    const scoreValue = data.best_params.score ?? data.best_score;
                    optunaBestScore.textContent = scoreValue !== null && scoreValue !== undefined ? Number(scoreValue).toFixed(4) : '--';
                    optunaBestBox.classList.remove('d-none');
                    optunaApplyBtn.disabled = false;
                }
                if (data.status === 'completed') {
                    stopOptunaPolling();
                    optunaProgressBar.classList.add('bg-success');
                    optunaError.classList.add('d-none');
                } else if (data.status === 'failed') {
                    stopOptunaPolling();
                    handleOptunaError('Optimization ended without improvement.');
                }
            })
            .catch(() => {
                handleOptunaError('Unable to fetch optimization status.');
            });
    }

    function startOptunaOptimization() {
        resetOptunaUI();
        optunaStatusBox.classList.remove('d-none');
        optunaStartBtn.disabled = true;
        updateMatrixJson();
        const formEl = document.getElementById('simForm');
        const formData = new FormData(formEl);
        fetch(OPTUNA_START_URL, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.job_id) {
                    optunaJobId = data.job_id;
                    optunaLog.textContent = 'Starting optimization...\n';
                    optunaPollHandle = setInterval(pollOptunaStatus, 2000);
                    pollOptunaStatus();
                } else if (data.error) {
                    handleOptunaError(JSON.stringify(data.error));
                } else {
                    handleOptunaError('Unexpected response from optimizer.');
                }
            })
            .catch(() => handleOptunaError('Failed to start optimization.'));
    }

    function applyOptunaBest() {
        if (!optunaBestParams) {
            return;
        }
        const qTempInput = document.getElementById('id_q_temp_weight');
        const qEnergyInput = document.getElementById('id_q_energy_weight');
        const rInput = document.getElementById('id_r_weight');
        if (qTempInput) qTempInput.value = Number(optunaBestParams.q_temp_weight);
        if (qEnergyInput) qEnergyInput.value = Number(optunaBestParams.q_energy_weight);
        if (rInput) rInput.value = Number(optunaBestParams.r_weight);
    }

    if (optunaStartBtn) {
        optunaStartBtn.addEventListener('click', startOptunaOptimization);
    }
    if (optunaApplyBtn) {
        optunaApplyBtn.addEventListener('click', applyOptunaBest);
    }
</script>
{% endblock %}

